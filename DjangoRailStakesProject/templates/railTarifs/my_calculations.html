{% extends "railTarifs/base.html" %}
{% block title %}Мои расчёты{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Мои расчёты</h1>
  <a class="btn btn-outline-primary btn-sm" href="{% url 'railTarifs:tariff_calc' %}">Новый расчёт</a>
</div>

{% if page.object_list %}
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Дата</th>
            <th>Маршрут</th>
            <th>Груз</th>
            <th>Вагон</th>
            <th class="text-end">Итог</th>
            <th>Статус</th>
          </tr>
        </thead>
        <tbody>
          {% for q in page.object_list %}
            <tr>
              <td class="text-nowrap">{{ q.created_at|date:"d.m.Y H:i" }}</td>
              <td>
                {{ q.from_station.name }} ({{ q.from_station.code }})
                → {{ q.to_station.name }} ({{ q.to_station.code }})
              </td>
              <td>{{ q.cargo.name }}</td>
              <td class="text-nowrap">{{ q.wagon_type.name }}</td>

              <td class="text-end text-nowrap">
                {% if q.result and q.result.ok and q.result.total_price %}
                  <strong>{{ q.result.total_price }}</strong> {{ q.result.currency }}
                {% else %}
                  —
                {% endif %}
              </td>

              <td class="text-nowrap">
                {% if q.result %}
                  {% if q.result.ok %}
                    <span class="badge bg-success">ok</span>
                  {% else %}
                    <span class="badge bg-danger">ошибка</span>
                  {% endif %}
                {% else %}
                  <span class="badge bg-secondary">нет данных</span>
                {% endif %}
              </td>
            </tr>

            {% if q.result and q.result.raw_xml %}
            <tr class="table-light">
              <td colspan="6">
                <details>
                  <summary>Показать сырой ответ API (XML)</summary>
                  <pre class="mt-2 mb-0" style="max-height: 260px; overflow:auto;">{{ q.result.raw_xml|escape }}</pre>
                </details>
              </td>
            </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <nav class="mt-3">
    <ul class="pagination pagination-sm">
      {% if page.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page.previous_page_number }}">←</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">←</span></li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">Стр. {{ page.number }} из {{ page.paginator.num_pages }}</span>
      </li>

      {% if page.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page.next_page_number }}">→</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">→</span></li>
      {% endif %}
    </ul>
  </nav>

{% else %}
  <div class="text-muted">Пока нет сохранённых расчётов.</div>
{% endif %}
{% endblock %}